#include <WiFi.h>
#include <HTTPClient.h>
#include <DHT.h>

// --- WIFI SETTINGS ---
const char* ssid = "WIFI_SSID"; // CHANGE THIS TO YOUR OWN THE NAME OF YOUR WIFI
const char* password = "WIFI_PASSWORD"; //CHANGE THIS TO YOUR OWN

// --- SUPABASE SETTINGS ---
const char* supabase_url = "https://juaaocqwwczwoiphiphj.supabase.co/rest/v1/readings"; //EXAMPLE
const char* supabase_key = "ANON_KEY"; 

// --- SENSOR SETTINGS ---
#define SOIL_PIN 35
#define DHT_PIN 4
#define DHTTYPE DHT22
DHT dht(DHT_PIN, DHTTYPE);

// Calibration
const int dryValue = 3500;
const int wetValue = 1200;

void setup() {
  Serial.begin(115200);
  
  // 1. Start Sensors
  dht.begin();
  
  // 2. Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected!");
}

void loop() {
  // --- READ SENSORS ---
  int rawSoil = analogRead(SOIL_PIN);
  int moisture = map(rawSoil, dryValue, wetValue, 0, 100);
  moisture = constrain(moisture, 0, 100);
  
  float tempF = dht.readTemperature(true); // Fahrenheit
  float humid = dht.readHumidity();

  // Check for sensor errors
  if (isnan(tempF) || isnan(humid)) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }

  // --- SEND TO SUPABASE ---
  if(WiFi.status() == WL_CONNECTED){
    HTTPClient http;

    // 1. Begin the connection
    http.begin(supabase_url);

    // 2. Add Headers (Authentication)
    http.addHeader("Content-Type", "application/json");
    http.addHeader("apikey", supabase_key);
    http.addHeader("Authorization", String("Bearer ") + supabase_key);
    
    // 3. Create the JSON Data String
    // Format: {"moisture": 45, "temperature": 72.5, "humidity": 30}
    String jsonData = "{\"moisture\":" + String(moisture) + 
                      ", \"temperature\":" + String(tempF) + 
                      ", \"humidity\":" + String(humid) + "}";

    // 4. Send the POST Request
    int httpResponseCode = http.POST(jsonData);

    // 5. Check Result
    if(httpResponseCode > 0){
      Serial.print("Data Sent! Response: ");
      Serial.println(httpResponseCode); // 201 means Created (Success)
    } else {
      Serial.print("Error sending data: ");
      Serial.println(httpResponseCode);
      Serial.println(http.errorToString(httpResponseCode).c_str());
    }

    http.end(); // Close connection
  } else {
    Serial.println("WiFi Disconnected");
  }

  // WAIT 10 SECONDS (Supabase is free, don't spam it too fast!)
  delay(10000); 
}
